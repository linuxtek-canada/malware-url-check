#!/usr/bin/python3

#Author:    Jason Paul 
#Email:     jasonpa@gmail.com

import os
import boto3
import json
import validators
from boto3.dynamodb.conditions import Key

# Lambda Handler - cannot modify this method
def lambda_handler(event, context):  

  # Logging for CloudWatch
  print(event)

  dynamodb_client = boto3.client('dynamodb')
  dynamodb = boto3.resource('dynamodb')
  table = dynamodb.Table('MalwareBlacklist')
  MalwareURL = event['queryStringParameters']['MalwareURL']

  try:
    # Validate that the input is a proper URL.  Raise exception if it is not.
    validurl=validators.url(MalwareURL)        

    if validurl==True:
      # Query DynamoDB for the MalwareURL:             
      response = table.query(KeyConditionExpression=Key('BlacklistURL').eq(MalwareURL))      
      print(response)      

      # If the URL exists in the table, the ScannedCount will be > 0      
      if response['Count'] > 0:
        return {
          'statusCode': 200,
          'body': json.dumps('URL is present in blacklist!')
        }
      elif response['Count'] == 0:
        return {
          'statusCode': 200,
          'body': json.dumps('URL is not found in blacklist.  Proceed.')
        }
      else:                 
        return {
          'statusCode': 400,
          'body': json.dumps('We have  problem with the count check')
        }
        raise Exception('We have a problem with the count check.')    
    else:
      return {
          'statusCode': 400,
          'body': json.dumps('The URL is not valid.')
        }       
      raise Exception('URL is not valid.')
  
  except Exception:
    return {
          'statusCode': 400,
          'body': json.dumps('There was a problem querying the blacklist.')
        }       
    